<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>6.11％の奇跡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ベースリセット */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #444;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      min-height: 100vh;
    }
    /* （今回、通知エリアは使用しません） */
    #notification { display: none; }
    
    /* スロット台 */
    .slot-machine {
      width: 420px;
      background: #222;
      border: 6px solid #000;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
      position: relative;
      overflow: hidden;
      padding-bottom: 20px;
    }
    /* --- 上部ディスプレイ部 --- */
    .slot-display {
      background: #e9212d;
      padding: 10px;
      height: 120px;
      border-bottom: 3px solid #000;
      text-align: center;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
    }
    .slot-display h2 { font-size: 1.5em; margin-bottom: 8px; }
    /* 回転数のみ表示（当選数非表示）、中央寄せ */
    #spinCountContainer { display: flex; justify-content: center; }
    #spinCountText { font-size: 1.2em; }
    /* 結果メッセージは下部に表示 */
    #displayMessage { min-height: 20px; font-size: 1em; margin-top: 5px; }
    
    /* --- 本体下部：レバー＆リール+ボタン --- */
    .machine-body {
      display: flex; align-items: flex-start; justify-content: center;
      padding: 10px; position: relative;
    }
    /* レバー */
    .lever-container { width: 60px; height: 100px; position: relative; margin-right: 10px; }
    .lever-shaft {
      position: absolute; left: 28px; top: 0;
      width: 4px; height: 100px;
      background: linear-gradient(#bbb, #777); border-radius: 2px;
    }
    .lever-ball {
      position: absolute; left: 10px; top: 0;
      width: 40px; height: 40px;
      background: radial-gradient(#222, #000); border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.6) inset, 0 4px 6px rgba(0,0,0,0.8);
      user-select: none; -webkit-user-select: none;
      -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
      touch-action: none; transition: transform 0.2s ease;
      cursor: pointer;
    }
    .lever-ball.pressed { transform: translateY(40px); }
    
    /* --- リールとストップボタン --- */
    .reels-stop-area { display: flex; gap: 10px; }
    .reel-stop { display: flex; flex-direction: column; align-items: center; position: relative; }
    /* リール枠：横60px、縦は1:1画像3枚分の180px */
    .reel {
      width: 60px; height: 180px; overflow: hidden; border-radius: 8px;
      background: #000; box-shadow: inset 0 3px 10px rgba(0,0,0,0.5);
      margin-bottom: 6px; position: relative;
    }
    /* リール内 */
    .numbers { position: absolute; top: 0; left: 0; width: 100%; background: #fff; }
    .numbers div {
      height: 60px; line-height: 60px; text-align: center;
      background: transparent; color: #000; border-bottom: 1px solid #ccc;
      font-size: 1em;
    }
    /* ストップボタン（ユーザ操作可能） */
    .stop-btn {
      width: 60px; height: 60px; border-radius: 10px;
      border: 2px solid #aa0000;
      background: linear-gradient(to bottom, #ff5555, #bb0000);
      color: #fff; font-size: 0.8em; font-weight: bold;
      box-shadow: 0 0 4px rgba(0,0,0,0.8) inset, 0 3px 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }
    .stop-btn:active { transform: translateY(2px); box-shadow: inset 0 2px 4px rgba(0,0,0,0.6); }
    /* 初期状態ではストップボタンは無効（スピン開始時に有効化） */
    .stop-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    /* 停止時に太字 */
    .boldNumber { font-weight: bold; }
    
    /* silhouette.png と GOGO.png のスタイル */
    .silhouette-image, .gogo-image {
      position: absolute; top: 100px; left: -255px;
      width: 120px; height: auto; display: none;
    }
    .silhouette-image { display: block; }
    .gogo-image { z-index: 5; }
    
    /* リール内画像：1:1サイズ（60px×60px） */
    .numbers img { width: 100%; height: 60px; object-fit: contain; }
    
    /* バックボタン */
    .back-button-container {
      width: 100%; padding: 10px; border-radius: 8px;
      background-color: #222222; margin-top: 10px;
      text-align: center; cursor: pointer; position: relative;
    }
    .back-button-container img {
      width: 100%; height: auto; object-fit: contain; border-radius: 6px;
    }
    
    /* ヘルプモーダル */
    .modal {
      display: none; position: fixed; z-index: 200;
      left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0,0,0,0.5);
      justify-content: center; align-items: center; display: flex;
    }
    .modal-content {
      background-color: #fff; color: #000; padding: 20px 30px;
      border-radius: 8px; width: 80%; max-width: 400px; position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: left; line-height: 1.5em;
    }
    .modal-content h3 { margin-bottom: 15px; }
    .modal-content .close-modal-btn {
      position: absolute; top: 10px; right: 15px;
      background: none; border: none; font-size: 1.5em; cursor: pointer; color: #000;
    }
    .modal-content .close-modal-btn:hover { color: #555; }
    /* 結果ポップアップは中央表示 */
    #resultModal .modal-content { text-align: center; }
    
    /* 遊び方モーダルの追加説明文 */
    #helpModal .instructions {
      margin-top: 10px;
      font-size: 0.95em;
      line-height: 1.4em;
    }
    #helpModal .instructions img {
      vertical-align: middle;
      height: 1.2em;
      margin: 0 0.2em;
    }
    
    /* レスポンシブ */
    @media (max-width: 500px) {
      .slot-machine { width: 90%; max-width: 420px; }
      .modal-content { width: 90%; max-width: 400px; }
    }
    
    /* 点滅用オーバーレイ（初期非表示） */
    #blinkOverlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 300;
    }
  </style>
</head>
<body>

  <!-- （通知エリアは省略） -->
  
  <!-- 営業時間外メッセージ -->
  <div id="closed-message" style="display:none;">
    営業時間外です。<br>AM8時からPM12時にお越しください。
  </div>

  <div class="slot-machine" id="slotMachine">
    <!-- ディスプレイ部 -->
    <div class="slot-display">
      <h2>BIG CHANCE!</h2>
      <div id="spinCountContainer">
        <div id="spinCountText">回転数：0</div>
      </div>
      <div id="displayMessage">6.11％の確率で何かが起こる!!</div>
    </div>

    <!-- 本体下部：レバー＆リール -->
    <div class="machine-body">
      <!-- レバー -->
      <div class="lever-container">
        <div class="lever-shaft"></div>
        <div class="lever-ball" id="leverBall"></div>
      </div>
      <!-- リール部 -->
      <div class="reels-stop-area">
        <div class="reel-stop">
          <div class="reel" id="reel1">
            <div class="numbers" id="numbers1"></div>
          </div>
          <button class="stop-btn" id="stop1" disabled>STOP</button>
        </div>
        <div class="reel-stop">
          <div class="reel" id="reel2">
            <div class="numbers" id="numbers2"></div>
          </div>
          <button class="stop-btn" id="stop2" disabled>STOP</button>
        </div>
        <div class="reel-stop">
          <div class="reel" id="reel3">
            <div class="numbers" id="numbers3"></div>
          </div>
          <button class="stop-btn" id="stop3" disabled>STOP</button>
          <!-- silhouette と GOGO -->
          <img src="images/silhouette.png" alt="Silhouette" class="silhouette-image" id="silhouetteImage">
          <img src="images/GOGO.png" alt="GOGO" class="gogo-image" id="gogoImage">
        </div>
      </div>
    </div>

    <!-- バックボタン -->
    <div class="back-button-container" id="backButton">
      <img src="images/back.png" alt="Back" />
    </div>
  </div>

  <!-- ヘルプモーダル -->
  <div class="modal" id="helpModal">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeHelpModal">&times;</button>
      <h3>あそび方</h3>
      <p>黒いレバーをタップするとスロットが回転します！<br>
         ※スロットの流れは以下のとおりです。</p>
      <p>
        ・6.11％の確率で <img src="images/0.png" alt="0" style="vertical-align:middle; height:1.2em;">  
        <img src="images/3.png" alt="3" style="vertical-align:middle; height:1.2em;">  
        <img src="images/6.png" alt="6" style="vertical-align:middle; height:1.2em;"> が揃い、GOGO.pngが表示されます。<br>
        ・GOGOが表示されている場合、40％の確率で  
        <img src="images/pierrot.png" alt="pierrot" style="vertical-align:middle; height:1.2em;">  
        <img src="images/pierrot.png" alt="pierrot" style="vertical-align:middle; height:1.2em;">  
        <img src="images/pierrot.png" alt="pierrot" style="vertical-align:middle; height:1.2em;"> が揃います。<br>
        ・もし <img src="images/pierrot.png" alt="pierrot" style="vertical-align:middle; height:1.2em;"> が揃ったら、画面全体が素早く点滅（2回）し、その後自動で各リールが逆回転し、最終的に  
        <img src="images/7.png" alt="7" style="vertical-align:middle; height:1.2em;">  
        <img src="images/7.png" alt="7" style="vertical-align:middle; height:1.2em;">  
        <img src="images/7.png" alt="7" style="vertical-align:middle; height:1.2em;"> が揃います。<br>
        ・<img src="images/pierrot.png" alt="pierrot" style="vertical-align:middle; height:1.2em;"> なら男の子、  
        <img src="images/7.png" alt="7" style="vertical-align:middle; height:1.2em;"> なら女の子が生まれるよ！
      </p>
      <div class="instructions"></div>
    </div>
  </div>

  <!-- 結果ポップアップモーダル -->
  <div class="modal" id="resultModal">
    <div class="modal-content">
      <button class="close-modal-btn" id="closeResultModal">&times;</button>
      <h3>おめでとう！</h3>
      <p>第二子の性別は<br>女の子です！</p>
    </div>
  </div>

  <!-- 点滅用オーバーレイ -->
  <div id="blinkOverlay"></div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // --- 変数宣言 ---
      let spinCount = 0;
      // 初期状態は勝ちにならないよう、既定の最終結果は安全な画像群にしておく
      let finalResults = ['bell.png','bar.png','animal.png'];
      let isGogoActive = false;    // GOGO表示中かどうか
      let pierrotTriggered = false; // pierrot勝ちが発生したかどうか

      const spinCountText = document.getElementById('spinCountText');
      const displayMessage = document.getElementById('displayMessage');
      const leverBall = document.getElementById('leverBall');
      const silhouetteImage = document.getElementById('silhouetteImage');
      const gogoImage = document.getElementById('gogoImage');
      const slotMachine = document.getElementById('slotMachine');
      const stopBtn1 = document.getElementById('stop1');
      const stopBtn2 = document.getElementById('stop2');
      const stopBtn3 = document.getElementById('stop3');
      const numbers1 = document.getElementById('numbers1');
      const numbers2 = document.getElementById('numbers2');
      const numbers3 = document.getElementById('numbers3');

      const backButton = document.getElementById('backButton');
      const helpModal = document.getElementById('helpModal');
      const closeHelpModalBtn = document.getElementById('closeHelpModal');

      const resultModal = document.getElementById('resultModal');
      const closeResultModalBtn = document.getElementById('closeResultModal');

      // 各リールに表示する画像リスト
      const reelImages = {
        reel1: ['bell.png','7.png','pierrot.png','0.png','cherry.png','bar.png','animal.png'],
        reel2: ['bell.png','7.png','pierrot.png','cherry.png','bar.png','3.png','animal.png'],
        reel3: ['bell.png','7.png','pierrot.png','cherry.png','6.png','bar.png','animal.png']
      };

      let isSpinningFlag = [false, false, false];
      let reelPos = [0, 0, 0];
      let reelTimer = [null, null, null];
      const imageHeight = 60;
      const reelHeight = imageHeight * 7 * 4;
      const scrollSpeed = 60;

      /* 初回アクセス時の初期表示は安全な画像にする（例：各リールで固定表示） */
      function fillInitialReels() {
        // 各リールには勝ちにならない画像を固定表示
        fillReelImages(numbers1, ['bell.png']);
        fillReelImages(numbers2, ['bar.png']);
        fillReelImages(numbers3, ['animal.png']);
      }
      function fillReelImages(container, images) {
        const repeatTimes = 4;
        const items = [];
        for (let r = 0; r < repeatTimes; r++){
          images.forEach(img => items.push(img));
        }
        container.innerHTML = '';
        items.forEach(imgSrc => {
          const div = document.createElement('div');
          const img = document.createElement('img');
          img.src = `images/${imgSrc}`;
          img.alt = imgSrc.replace('.png','');
          img.style.width = '100%';
          img.style.height = imageHeight + 'px';
          img.style.objectFit = 'contain';
          div.appendChild(img);
          container.appendChild(div);
        });
      }

      /* --- ヘルプ／結果モーダル制御 --- */
      function showHelpModal() { helpModal.style.display = 'flex'; }
      function hideHelpModal() { helpModal.style.display = 'none'; }
      function showResultModal() { resultModal.style.display = 'flex'; }
      function hideResultModal() { resultModal.style.display = 'none'; }

      /* --- GOGO切替 --- */
      function showGogo() {
        isGogoActive = true;
        silhouetteImage.style.display = 'none';
        gogoImage.style.display = 'block';
      }
      function hideGogo() {
        isGogoActive = false;
        gogoImage.style.display = 'none';
        silhouetteImage.style.display = 'block';
      }

      /* --- 点滅効果 --- */
      function blinkScreen(times, callback) {
        const overlay = document.getElementById('blinkOverlay');
        let count = 0;
        const interval = setInterval(() => {
          overlay.style.opacity = (overlay.style.opacity == 0 ? 1 : 0);
          count++;
          if (count >= times * 2) { // on/off を1回とカウント
            clearInterval(interval);
            overlay.style.opacity = 0;
            if (callback) callback();
          }
        }, 150);
      }

      /* --- 自動逆回転処理 --- */
      function autoReverseSpin(callback) {
        let reverseTimers = [null, null, null];
        for (let idx = 0; idx < 3; idx++) {
          reverseTimers[idx] = setInterval(() => {
            reelPos[idx] -= 5;
            if (reelPos[idx] < 0) { reelPos[idx] += reelHeight; }
            const container = [numbers1, numbers2, numbers3][idx];
            container.style.transform = `translateY(-${reelPos[idx]}px)`;
            const allDivs = container.querySelectorAll('div');
            let bestIndex = 0, minDistance = Infinity;
            for (let i = 0; i < allDivs.length; i++) {
              const img = allDivs[i].querySelector('img');
              if (!img) continue;
              const src = img.getAttribute('src').split('/').pop();
              if (src === '7.png') {
                const desiredOffset = i * imageHeight - imageHeight;
                const distance = Math.abs(desiredOffset - reelPos[idx]);
                if (distance < minDistance) { minDistance = distance; bestIndex = i; }
              }
            }
            if (minDistance < 5) {
              clearInterval(reverseTimers[idx]);
              reelPos[idx] = bestIndex * imageHeight - imageHeight;
              container.style.transform = `translateY(-${reelPos[idx]}px)`;
            }
            if (!reverseTimers[0] && !reverseTimers[1] && !reverseTimers[2]) {
              if (callback) callback();
            }
          }, 50);
        }
      }

      /* --- レバー押下処理 --- */
      function handleLeverPress() {
        leverBall.classList.add('pressed');
        startSpin();
      }
      function startSpin() {
        spinCount++;
        spinCountText.textContent = `回転数：${spinCount}`;
        displayMessage.textContent = "";
        // 初期状態からは、GOGO状態を解除し、pierrot判定もリセット
        hideGogo();
        pierrotTriggered = false;
        // 抽選処理
        let rand = Math.random();
        console.log("Spin rand:", rand);
        if (rand < 0.0611) {
          // 6.11%の確率で[0,3,6]に → その結果、GOGO表示
          finalResults = ['0.png', '3.png', '6.png'];
          showGogo();
        } else {
          finalResults = [
            getRandomImage('reel1'),
            getRandomImage('reel2'),
            getRandomImage('reel3')
          ];
        }
        // 各リールの回転開始
        for (let i = 0; i < 3; i++) { startReel(i); }
        // ストップボタンを有効化
        stopBtn1.disabled = false;
        stopBtn2.disabled = false;
        stopBtn3.disabled = false;
      }
      function getRandomImage(reel) {
        const images = reelImages[reel];
        return images[Math.floor(Math.random() * images.length)];
      }
      function startReel(idx) {
        isSpinningFlag[idx] = true;
        reelPos[idx] = 0;
        const container = [numbers1, numbers2, numbers3][idx];
        if (reelTimer[idx]) clearInterval(reelTimer[idx]);
        reelTimer[idx] = setInterval(() => {
          reelPos[idx] += scrollSpeed;
          if (reelPos[idx] > reelHeight) { reelPos[idx] %= reelHeight; }
          container.style.transform = `translateY(-${reelPos[idx]}px)`;
        }, 20);
      }
      // ストップボタンのイベント
      stopBtn1.addEventListener('click', () => { stopReel(0, stopBtn1); });
      stopBtn2.addEventListener('click', () => { stopReel(1, stopBtn2); });
      stopBtn3.addEventListener('click', () => { stopReel(2, stopBtn3); });
      function stopReel(idx, btn) {
        if (!isSpinningFlag[idx]) return;
        clearInterval(reelTimer[idx]);
        isSpinningFlag[idx] = false;
        btn.disabled = true;
        const container = [numbers1, numbers2, numbers3][idx];
        const allDivs = container.querySelectorAll('div');
        allDivs.forEach(div => div.classList.remove('boldNumber'));
        let bestIndex = 0, minDistance = Infinity;
        for (let i = 0; i < allDivs.length; i++){
          const img = allDivs[i].querySelector('img');
          if (!img) continue;
          const src = img.getAttribute('src').split('/').pop();
          if (src === finalResults[idx]) {
            const desiredOffset = i * imageHeight - imageHeight;
            const distance = Math.abs(desiredOffset - reelPos[idx]);
            if (distance < minDistance) { minDistance = distance; bestIndex = i; }
          }
        }
        reelPos[idx] = bestIndex * imageHeight - imageHeight;
        container.style.transform = `translateY(-${reelPos[idx]}px)`;
        allDivs[bestIndex].classList.add('boldNumber');
        // すべてのリール停止時に結果チェック
        if (!isSpinningFlag[0] && !isSpinningFlag[1] && !isSpinningFlag[2]) {
          checkResult();
        }
      }
      function checkResult() {
        console.log("Final results:", finalResults);
        // もし[0,3,6]が揃ってかつGOGO状態なら、さらに40％で pierrot勝ちに移行
        if (finalResults[0]==='0.png' && finalResults[1]==='3.png' && finalResults[2]==='6.png' && isGogoActive) {
          let rand = Math.random();
          console.log("GOGO extra chance rand:", rand);
          if (rand < 0.4) {
            finalResults = ['pierrot.png','pierrot.png','pierrot.png'];
            pierrotTriggered = true;
          }
        }
        if (pierrotTriggered) {
          // pierrot勝ちなら点滅→逆回転→最終的に[7,7,7]に
          displayMessage.textContent = "当たり";
          blinkScreen(2, () => {
            autoReverseSpin(() => {
              displayMessage.textContent = "";
              showResultModal();
            });
          });
        } else {
          // 通常の場合は、特に勝ちメッセージは表示しない
          displayMessage.textContent = "";
        }
      }
      
      /* --- イベントリスナー --- */
      // レバー操作（PC・タッチ対応）
      leverBall.addEventListener('mousedown', e => { e.preventDefault(); handleLeverPress(); });
      leverBall.addEventListener('mouseup', () => { leverBall.classList.remove('pressed'); });
      leverBall.addEventListener('mouseleave', () => { leverBall.classList.remove('pressed'); });
      leverBall.addEventListener('touchstart', e => { e.preventDefault(); handleLeverPress(); }, {passive:false});
      leverBall.addEventListener('touchend', () => { leverBall.classList.remove('pressed'); });
      leverBall.addEventListener('touchcancel', () => { leverBall.classList.remove('pressed'); });
      
      // ストップボタンは上記で個別に設定済み
      
      // ヘルプ／結果モーダル関連
      closeHelpModalBtn.addEventListener('click', hideHelpModal);
      backButton.addEventListener('click', showHelpModal);
      closeResultModalBtn.addEventListener('click', hideResultModal);
      
      // 初回表示は安全な状態になるように初期リールを固定表示
      fillInitialReels();
      spinCountText.textContent = `回転数：0`;
      displayMessage.textContent = "6.11％の確率で何かが起こる!!";
      
      // ※必要に応じて営業時間チェック等も追加してください
    });
  </script>
</body>
</html>
